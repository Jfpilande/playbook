---

- name: IPL single IBMi host

  host: '{{ testhost }}'
  gather_facts: false
  collections:
    - ibm.power_ibmi

  vars:
    auto_ipl: false
    pre_reboot_delay: 60
    post_reboot_delay: 60
    reboot_timeout: 1800
    connect_timeout: 300
    test_command: 'uname'
    msg: 'Reboot initiated by Ansible'
    how_to_end: '*IMMED'
    controlled_end_delay_time: 600
    reboot_type: '*IPLA'
    ipl_source: '*PANEL'
    end_subsystem_option: '*DFT'
    timeout_option: '*CONTINUE'
    parameters: ''

  tasks:

    - name: Query the list of ptfs which requires an IPL
      ibmi_sql_query:
        sql: "SELECT PTF_IDENTIFIER, PTF_PRODUCT_ID, PTF_IPL_ACTION, A.* FROM QSYS2.PTF_INFO A WHERE PTF_IPL_ACTION <> 'NONE'"
      register: query_ptf_result

    - name: Debug msg
      debug:
        msg: 'No PTFs require an IPL.'
      when: query_ptf_result.row | length == 0